- 출처 : [How Anthropic is using ClickHouse to scale observability for the AI era](https://clickhouse.com/blog/how-anthropic-is-using-clickhouse-to-scale-observability-for-ai-era)
- 클로드가 대히트치면서, 앤트로픽의 관측 가능성 팀은 터져 나가는 텔레메트리, 매트릭, 로그의 관리를 하고 있었다.
  - 새 모델이 나올때마다, 규모가 더 켜졌다.
  - 다음과 같은 요구사항이 있었다.
    - 실시간으로 이슈를 캐치할 수 있어야 한다.
    - 민감한 데이터의 유출을 막아야 한다.
    - 강하게 통제되고 안전하도록 설계된 컴퓨터 환경 내부에서 모든 것을 돌릴 수 있었어야 한다.
- 사용량은 폭증하고, 모델은 점점 복잡해지고, 인프라는 빠르게 스케일될 수 있어야 했다.
  - 모니터링, 트러블 슈팅, 복잡한 훈련에 대한 파인튠, 인퍼런싱 해야하는 데이터에 대한 연산 footprint가 풍선처럼 증가했다
    - 기존 관측 시스템으로 따라가기 어려웠다.
      - 엄청나게 큰 데이터가 있으면 DB가 터져나가고, 쿼리 타임아웃 뜨고, 엔지니어는 맛이 가고, 돈은 미친듯이 나간다.
  - 이 와중에 Anthropic의 보안 안전 표준은 더 엄격해졌다.
    - 이러한 노력은 데이터의 접근을 잠그었다.
  - 가장 모델이 나쁜 사람에 의해 굉장히 잘못된 출력이 나오지 않도록 하려 했고, 이를 위해 모든 egress를 모니터링 했으며, 어떤 데이터도 Anthropic의 보안 컴퓨팅 환경을 나오지 못하게 하였다.
- Choosing ClickHouse to scale observability
  - 앤트로픽의 목표는 다음과 같았다.
    - 엄청나게 많은 양의 데이터를 실시간으로 처리할 수 있어야 한다.
    - 빠르고, 상호 작용이 가능하며, 다양한 기능의 분석이 필요하다.
    - Anthropic의 보안 컴퓨팅 환경에 구축할 수 있어야 한다.
    - Scalable한 비용 구조가 피료하다.
    - 제일 중요하게, 현대 표준 관측가능성 툴들과 잘 작동해야 하며, 최소한의 유지보수로 운영할 수 있었어야 한다.
      - 1월까지 팀이 3명이었다.
  - Claude에 물어봤더니 클릭하우스를 추천했고, 찾아보니 실제로 사용할 수 있을 것으로 보였다.
    - 빠른 분석, 유연한 배포, 비용 효율성을 갖추었다.
- Deploying ClickHouse, the Anthropic
  - 클릭하우스 자체는 기술적으로 적절했는데, 배포 전략이 필요와 맞지 않았다.
    - 오픈 소스 버전은 확실히 이점이 있었지만, 직접 디스크 레플리카 리샤딩을 관리해야 하는 것이 문제였다.
    - 클릭하우스 클라우드는 다이나믹 스케일링이 있고, 효율적인 blob 스토리지로 구성되는것이 장점이었지만, 모든 것을 자체 보안 환경에서 돌려야 한다는 것이 문제였다.
    - Hybrid approach를 사용하기로 했다.
      클릭하우스 팀과 같이 Anthropic 인프라 내부에 커스텀, 분리된 형태의 클릭하우스 클라우드 아키텍처를 구현하였다.
      - 컨트롤 플레인부터 데이터 플레인까지 보안 인프라 내부에서 작동하도록 했다.
      - 클러스터는 쿠버네티스 내부에서 클릭하우스 오퍼레이터와 동작하고, AZ마다 하나씩 3개의 AZ에 주키퍼를 두어 작동하도록 했다.
      - 오브젝트 스토리지를 backing layer로 하는 수평 확장 가능한 서버를 구성하였다.
  - 프로메테우스가 핸들링하고, Vector로 데이터를 수집하도록 하여 관측 파이프라인을 구성하였다.
    - 요청 규모에 따라 스케일되고, 엔지니어들이 지속적인 점검을 할 필요 없도록 구성되었다.
    - 이 구성으로 이전 솔루션보다 개선되었다.
      - 이전 솔루션은 DBA가 어떤걸 해야할지 모르거나 할 수 없는 일이라  리샤딩, 쓰기 레플리케이션때문에 하루종일 기술지원 받는 일이 사라졌다.
  - 클릭하우스 도입 이후, 거대한 데이터셋에 대해 빠르고 신뢰할 수 있는 쿼리를 자연스럽게 돌리게 되었다.
    - 이를 통해 인프라에 대한 고민 없이 더 나은 툴, 더 나은 모델, 클로드가 할 수 있는 것의 바운더리를 넓히는 일에 집중할 수 있었다.
    - 모델을 학습할 때, 퍼포먼스 메트릭과 시스템의 행동에 대한 일관된 가시성의 제공이 필요하고, 클릭하우스를 통해 빠르고 유연하게 데이터를 실시간으로 제공할 수 있었다.
  - MCP 개발을 통해 클로드와 클릭하우스를 연결하여 자연어를 통해 관측 가능성에 대한 응답을 얻도록 구성할 수 있었다.
    - 관측 가능성이 SQL이나 PromQL에 관한 얘기가 아니라, 질문 중심으로 구성하도록 할 수 있게 되는 것이다.
